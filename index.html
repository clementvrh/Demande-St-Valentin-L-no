<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valentine üíò</title>

  <style>
    :root{
      --bg: #fff8fb;
      --text: #2b2b2b;
      --muted: #6b6b6b;
      --pink: #ff4d79;
      --pink2: #ff2f6b;
      --shadow: 0 12px 30px rgba(255, 77, 121, .22);
      --ease: cubic-bezier(.22,.61,.36,1);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 50% 20%, #fff 0%, var(--bg) 55%, #ffe8f0 100%);
      color: var(--text);
      overflow:hidden;
      cursor:none !important;
    }
    button, a, input, label, textarea, select{ cursor:none !important; }

    @media (hover: none) and (pointer: coarse){
      body{ cursor:auto !important; }
      #cursorDot{ display:none !important; }
      button, a, input, label, textarea, select{ cursor:auto !important; }
    }

    #cursorDot{
      position:fixed; left:0; top:0;
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle at 35% 35%, #ffd1df 0%, var(--pink) 45%, var(--pink2) 100%);
      box-shadow: 0 0 16px rgba(255,47,107,.30), 0 0 30px rgba(255,47,107,.16);
      transform: translate(-50%,-50%);
      pointer-events:none;
      z-index:9999;
      opacity:0;
      transition: opacity .15s ease;
      will-change: transform;
    }

    /* BG hearts */
    #bg{ position:fixed; inset:0; overflow:hidden; pointer-events:none; }
    .bubble-heart{
      position:absolute; bottom:-60px; left:0;
      opacity:.18;
      animation: floatUp linear forwards;
      will-change: transform, opacity;
      text-shadow: 0 10px 25px rgba(255,77,121,.22);
      filter: drop-shadow(0 10px 20px rgba(255,77,121,.16));
    }
    @keyframes floatUp{
      0%{ transform: translate3d(0,0,0) scale(1); opacity:0; }
      10%{ opacity: var(--o,.22); }
      90%{ opacity: var(--o,.22); }
      100%{ transform: translate3d(var(--dx,0px), -120vh, 0) scale(var(--s,1)); opacity:0; }
    }

    .stage{
      position:relative;
      height:100%;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .card{
      width:min(900px, 94vw);
      min-height:380px;
      border-radius:22px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.07);
      border: 1px solid rgba(255,255,255,.55);
      position:relative;
      overflow: visible;
      transition: opacity .35s ease;
    }
    .card.loadingMode{
      background: transparent;
      border-color: transparent;
      box-shadow: none;
      backdrop-filter: none;
    }

    .screen{
      position:absolute; inset:0;
      padding:34px 18px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .55s var(--ease), transform .55s var(--ease);
      text-align:center;
    }
    .screen.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    .hearts-top{
      display:flex; gap:10px;
      justify-content:center; align-items:center;
      margin-bottom:8px; height:52px;
    }
    .heart{
      width:32px; height:32px;
      position:relative;
      transform: rotate(-45deg);
      background: var(--pink);
      border-radius:7px;
      animation: beat 1.2s ease-in-out infinite;
      filter: drop-shadow(0 12px 18px rgba(255,77,121,.22)) drop-shadow(0 0 14px rgba(255,77,121,.22));
    }
    .heart::before,.heart::after{
      content:"";
      position:absolute;
      width:32px; height:32px;
      background: var(--pink);
      border-radius:50%;
    }
    .heart::before{ top:-16px; left:0; }
    .heart::after{ left:16px; top:0; }
    .heart.small{ width:22px; height:22px; animation-duration:1.35s; opacity:.95; }
    .heart.small::before,.heart.small::after{ width:22px; height:22px; }
    .heart.small::before{ top:-11px; }
    .heart.small::after{ left:11px; }
    @keyframes beat{
      0%,100%{ transform: rotate(-45deg) scale(1); }
      18%{ transform: rotate(-45deg) scale(1.08); }
      36%{ transform: rotate(-45deg) scale(.98); }
      54%{ transform: rotate(-45deg) scale(1.12); }
      72%{ transform: rotate(-45deg) scale(1); }
    }

    h1{
      font-size: clamp(26px, 3.2vw, 40px);
      line-height:1.15;
      margin:10px 0 18px;
      min-height: 96px; /* keeps layout stable during typewriter */
    }
    .name{
      font-weight:950;
      background: linear-gradient(90deg, var(--pink2), #ff7aa2);
      -webkit-background-clip:text; background-clip:text;
      color: transparent;
      white-space: nowrap;
    }

    .buttons{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
      margin-top:18px;
      height:58px;
    }
    button{
      border:0;
      padding:12px 18px;
      border-radius:999px;
      font-weight:950;
      font-size:16px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      white-space:nowrap;
      transition: transform .12s ease, box-shadow .22s ease, background .22s ease, opacity .22s ease;
    }
    #yesBtn{
      background: var(--pink);
      color:#fff;
      box-shadow: var(--shadow);
      min-width:120px;
    }
    #yesBtn:hover{ transform: translateY(-1px); }
    #yesBtn:active{ transform: translateY(1px) scale(.99); }

    #noBtn{
      background: rgba(255,77,121,.10);
      color: var(--pink2);
      border: 1px solid rgba(255,77,121,.25);
      min-width:130px;
      max-width: 240px;
      overflow:hidden;
      text-overflow:ellipsis;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      backdrop-filter: blur(8px);
    }
    #noBtn.fixedRoam{
      position: fixed;
      left: 0; top: 0;
      transform: none;
      z-index: 50;
      transition: left .18s var(--ease), top .18s var(--ease), opacity .25s ease;
    }

    .hint{
      margin-top:12px;
      font-size:13px;
      color: rgba(0,0,0,.40);
      font-weight:850;
      min-height:18px;
      opacity:0;
      transform: translateY(4px);
      transition: opacity .35s ease, transform .35s ease;
    }
    .hint.show{ opacity:1; transform: translateY(0); }

    /* FX */
    #fx{ position:fixed; inset:0; pointer-events:none; z-index:9998; }
    .popHeart{
      position:absolute;
      transform: translate(-50%,-50%);
      opacity:0;
      animation: popFly 900ms var(--ease) forwards;
      filter: drop-shadow(0 10px 18px rgba(255,47,107,.22));
      will-change: transform, opacity;
    }
    @keyframes popFly{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.6); }
      10%{ opacity:1; }
      100%{
        opacity:0;
        transform: translate(calc(-50% + var(--dx,0px)), calc(-50% + var(--dy,-120px))) scale(var(--s,1.25)) rotate(var(--r,10deg));
      }
    }

    /* LOADING */
    .loadStage{
      height:100%;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      padding-top: 8px;
    }
    #loadPhoto{
      width: min(520px, 82vw);
      height:auto;
      max-height: 260px;
      object-fit: contain;
      opacity: 1;
      transition: opacity .35s ease;
      border-radius: 0;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.12));
    }
    #loadPhoto.fade{ opacity:0; }

    .loadPanel{
      width: min(560px, 86vw);
      border-radius: 18px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: 0 18px 50px rgba(0,0,0,.06);
      padding: 26px 18px 22px;
    }
    .loaderHeart{
      width:30px; height:30px;
      transform: rotate(-45deg);
      background: var(--pink2);
      border-radius:7px;
      animation: beat 1.15s ease-in-out infinite;
      position:relative;
      margin: 0 auto 10px;
    }
    .loaderHeart::before,.loaderHeart::after{
      content:"";
      position:absolute;
      width:30px; height:30px;
      background: var(--pink2);
      border-radius:50%;
    }
    .loaderHeart::before{ top:-15px; left:0; }
    .loaderHeart::after{ left:15px; top:0; }

    .bar{
      width: min(440px, 80vw);
      height: 10px;
      background: rgba(255,77,121,.15);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,77,121,.18);
      margin: 8px auto 10px;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--pink2), #ff7aa2);
      border-radius:999px;
      transition: width .18s var(--ease);
    }
    .percent{ font-weight:950; color: var(--pink2); margin-bottom: 8px; font-size: 18px; }
    .loadingText{
      color: var(--muted);
      font-weight: 900;
      min-height: 22px;
      opacity: 1;
      transition: opacity .35s ease, transform .35s ease;
      transform: translateY(0);
      font-size: 15px;
    }
    .loadingText.fadeOut{ opacity:0; transform: translateY(6px); }

    /* FINAL */
    .finalText{
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 12px;
      max-width: 560px;
      margin: 0 auto;
      padding-top: 10px;
    }
    .finalTitle{ font-size: clamp(44px, 4.6vw, 60px); margin:0; }
    .finalSub{ margin:0; color: rgba(0,0,0,.55); font-weight:900; font-size:20px; }
    .finalLove{ margin:0; font-weight:950; font-size:22px; }

    .finalHeartWrap{
      width: 100px; height: 100px;
      animation: finalBeat 1.25s ease-in-out infinite;
      filter: drop-shadow(0 16px 34px rgba(255,47,107,.22));
    }
    @keyframes finalBeat{
      0%,100%{ transform: scale(1); }
      18%{ transform: scale(1.06); }
      36%{ transform: scale(.99); }
      54%{ transform: scale(1.09); }
      72%{ transform: scale(1); }
    }

    .finalPolaroids{
      position:absolute;
      right: -120px;
      top: 28px;
      width: 280px;
      height: 520px;
      pointer-events:none;
    }
    .slot{
      position:absolute;
      width: 260px;
      height:auto;
      border-radius: 0;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,.14));
      opacity: 0;
      transition: opacity .5s ease, transform .5s ease;
    }
    .slot.show{ opacity:1; }

    .slot.pos1{ right:0; top:-6px; transform: rotate(6deg) translateY(6px); }
    .slot.pos1.show{ transform: rotate(6deg) translateY(0); }

    /* pos2 slightly right and lower */
    .slot.pos2{ right:-16px; top:245px; transform: rotate(-7deg) translateY(6px); }
    .slot.pos2.show{ transform: rotate(-7deg) translateY(0); }

    /* pos3 more to the right, between pos1 and pos2 */
    .slot.pos3{ right:-26px; top:145px; transform: rotate(3deg) translateY(6px); }
    .slot.pos3.show{ transform: rotate(3deg) translateY(0); }

    @media (max-width: 980px){
      .finalPolaroids{
        position: static;
        width:auto;
        height:auto;
        margin: 18px auto 0;
        display:flex;
        gap: 14px;
        justify-content:center;
        pointer-events:auto;
      }
      .slot{
        position: static;
        width: min(300px, 70vw);
        transform:none !important;
        opacity:1;
      }
      .slot.show{ opacity:1; transform:none; }
    }
  </style>
</head>

<body>
  <div id="bg" aria-hidden="true"></div>
  <div id="fx" aria-hidden="true"></div>
  <div id="cursorDot" aria-hidden="true"></div>

  <div class="stage">
    <div class="card" id="card">

      <!-- SCREEN 1 -->
      <section id="screenAsk" class="screen active">
        <div class="hearts-top">
          <div class="heart"></div>
          <div class="heart small"></div>
        </div>

        <h1 id="questionTitle"></h1>

        <div class="buttons">
          <button id="yesBtn">Oui ! üíû</button>
          <button id="noBtn">Non</button>
        </div>

        <div id="hint" class="hint"></div>
      </section>

      <!-- SCREEN 2 -->
      <section id="screenLoad" class="screen">
        <div class="loadStage">
          <img id="loadPhoto" src="assets/final1.png" alt="Nous - loading">
          <div class="loadPanel">
            <div class="loaderHeart"></div>
            <div class="bar"><i id="barFill"></i></div>
            <div class="percent"><span id="pct">0</span>%</div>
            <div class="loadingText" id="loadingText">Chargement de l‚Äôamour en cours‚Ä¶ üíò</div>
          </div>
        </div>
      </section>

      <!-- SCREEN 3 -->
      <section id="screenDone" class="screen">
        <div class="finalText">
          <div class="finalHeartWrap" aria-hidden="true">
            <!-- heart: rounder -->
            <svg viewBox="0 0 120 120" width="100" height="100">
              <defs>
                <radialGradient id="gMain" cx="35%" cy="28%" r="82%">
                  <stop offset="0%" stop-color="#ffd1df"/>
                  <stop offset="38%" stop-color="#ff6b97"/>
                  <stop offset="72%" stop-color="#ff2f6b"/>
                  <stop offset="100%" stop-color="#d80f4b"/>
                </radialGradient>
                <radialGradient id="gHi" cx="28%" cy="26%" r="60%">
                  <stop offset="0%" stop-color="rgba(255,255,255,.92)"/>
                  <stop offset="55%" stop-color="rgba(255,255,255,.16)"/>
                  <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
                </radialGradient>
                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur stdDeviation="5" result="b"/>
                  <feColorMatrix in="b" type="matrix"
                    values="1 0 0 0 0
                            0 .25 0 0 0
                            0 0 .35 0 0
                            0 0 0 .40 0" result="pb"/>
                  <feMerge>
                    <feMergeNode in="pb"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
                <filter id="inner" x="-50%" y="-50%" width="200%" height="200%">
                  <feOffset dx="0" dy="2"/>
                  <feGaussianBlur stdDeviation="3" result="ob"/>
                  <feComposite in="ob" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="is"/>
                  <feColorMatrix in="is" type="matrix"
                    values="0 0 0 0 0
                            0 0 0 0 0
                            0 0 0 0 0
                            0 0 0 .24 0"/>
                  <feComposite in2="SourceGraphic" operator="over"/>
                </filter>
              </defs>

              <path filter="url(#glow)" fill="url(#gMain)"
                d="M60 109
                   C60 109, 12 82, 12 46
                   C12 24, 30 13, 47 13
                   C57 13, 60 19, 60 19
                   C60 19, 63 13, 73 13
                   C90 13, 108 24, 108 46
                   C108 82, 60 109, 60 109 Z" />
              <path filter="url(#inner)" fill="url(#gMain)"
                d="M60 109
                   C60 109, 12 82, 12 46
                   C12 24, 30 13, 47 13
                   C57 13, 60 19, 60 19
                   C60 19, 63 13, 73 13
                   C90 13, 108 24, 108 46
                   C108 82, 60 109, 60 109 Z" />
              <path fill="url(#gHi)" opacity="0.55"
                d="M60 109
                   C60 109, 12 82, 12 46
                   C12 24, 30 13, 47 13
                   C57 13, 60 19, 60 19
                   C60 19, 63 13, 73 13
                   C90 13, 108 24, 108 46
                   C108 82, 60 109, 60 109 Z" />
            </svg>
          </div>

          <h2 class="finalTitle">Yeees&nbsp;!</h2>
          <p class="finalSub">Je savais que tu allais dire oui üíû</p>
          <p class="finalLove">Je t‚Äôaime ma L√©no ‚ù§Ô∏è</p>
        </div>

        <div class="finalPolaroids" aria-label="Polaroids">
          <img id="slot1" class="slot pos1" alt="photo 1">
          <img id="slot2" class="slot pos2" alt="photo 2">
          <img id="slot3" class="slot pos3" alt="photo 3">
        </div>
      </section>

    </div>
  </div>

  <script>
    // ===== cursor =====
    const cursorDot = document.getElementById('cursorDot');
    let curX = innerWidth/2, curY = innerHeight/2;
    let targetX = curX, targetY = curY;
    let cursorVisible = false;

    function cursorLoop(){
      curX += (targetX - curX) * 0.22;
      curY += (targetY - curY) * 0.22;
      cursorDot.style.transform = `translate(${curX}px, ${curY}px) translate(-50%, -50%)`;
      requestAnimationFrame(cursorLoop);
    }
    cursorLoop();

    addEventListener('mousemove', (e) => {
      targetX = e.clientX; targetY = e.clientY;
      if(!cursorVisible){ cursorVisible = true; cursorDot.style.opacity='1'; }
    }, {passive:true});

    addEventListener('mouseleave', () => {
      cursorVisible = false;
      cursorDot.style.opacity='0';
    });

    // ===== BG hearts =====
    const bg = document.getElementById('bg');
    const heartChars = ["‚ù§","üíó","üíñ","üíò","üíû","üíï"];
    function spawnBubble(){
      const el = document.createElement('div');
      el.className = 'bubble-heart';
      el.textContent = heartChars[(Math.random()*heartChars.length)|0];

      const x = Math.random() * innerWidth;
      const size = 14 + Math.random()*22;
      const drift = (Math.random()*2 - 1) * 120;
      const opacity = 0.12 + Math.random()*0.22;
      const duration = 7 + Math.random()*8;

      el.style.left = `${x}px`;
      el.style.fontSize = `${size}px`;
      el.style.setProperty('--dx', `${drift}px`);
      el.style.setProperty('--o', opacity.toFixed(2));
      el.style.setProperty('--s', (0.85 + Math.random()*0.6).toFixed(2));
      el.style.animationDuration = `${duration}s`;

      bg.appendChild(el);
      setTimeout(() => el.remove(), duration*1000 + 250);
    }
    setInterval(spawnBubble, 260);
    for(let i=0;i<10;i++) setTimeout(spawnBubble, i*80);

    // ===== Screens =====
    const card = document.getElementById('card');
    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ===== Typewriter (smooth) for first screen =====
    const titleEl = document.getElementById('questionTitle');
    const fullTitle = `<span class="name">L√©nora Deparis Verhoeven</span>,<br/>veux-tu √™tre ma Valentine ?`;

    function typewriterHTML(el, html, msPerChar = 18){
      // We type plain text, but keep <span> formatting by splitting into tokens.
      // Simple approach: render without span during typing, then swap to final HTML at end.
      const plain = "L√©nora Deparis Verhoeven,\nveux-tu √™tre ma Valentine ?";
      el.textContent = "";
      let i = 0;

      const step = () => {
        i++;
        const shown = plain.slice(0, i);
        el.textContent = shown;
        el.innerHTML = el.textContent.replace("\n","<br/>");
        if(i < plain.length){
          // slight randomness for a smooth feel
          const jitter = (Math.random()*10)|0;
          setTimeout(step, msPerChar + jitter);
        } else {
          // snap to final rich HTML
          el.innerHTML = html;
        }
      };
      setTimeout(step, 200);
    }
    typewriterHTML(titleEl, fullTitle, 16);

    // ===== No button logic: place ONLY in allowed zones around card =====
    const noBtn = document.getElementById('noBtn');
    const yesBtn = document.getElementById('yesBtn');
    const hintEl = document.getElementById('hint');

    const noFirst = ["Non","T‚Äôes s√ªre ?","R√©fl√©chis mieux‚Ä¶","Allez üòá","Tu vas cliquer ‚ÄúOui‚Äù üòå"];
    const noRandomPool = [
      "On sait tous les deux que tu vas dire oui üòå",
      "Le destin a d√©j√† choisi üíò",
      "Le bouton ‚ÄòOui‚Äô te regarde üëÄ",
      "Attention moi aussi je sais bouder‚Ä¶",
      "Tu veux vraiment me briser le c≈ìur ? ü•∫",
      "Erreur 404 : ‚ÄòNon‚Äô introuvable",
      "Je refuse d‚Äôexister sans ton oui üò≠",
      "Clique oui et je te fais un bisou",
      "Ce bouton est en RTT aujourd‚Äôhui",
      "T‚Äôas gliss√©‚Ä¶ vers ‚ÄòOui‚Äô üôÇ",
      "√áa sent le ‚ÄòOui‚Äô √† plein nez",
      "On recommence : tu dis oui ? üòá",
      "Je suis programm√© pour fuir üòé",
      "Tu veux jouer ? Moi aussi üòà",
      "Je te laisse une chance‚Ä¶ de cliquer Oui",
      "C‚Äôest non‚Ä¶ enfin c‚Äôest oui",
      "Je fais semblant d‚Äô√™tre un choix",
      "Bon‚Ä¶ √ßa suffit, clique Oui ma L√©no üòò",
      "D√©sol√©, ce bouton n‚Äôest pas l‚Äôoption aujourd‚Äôhui üíÖ",
      "Le ‚ÄòNon‚Äô est en rupture de stock",
      "Le ‚ÄòOui‚Äô est juste l√† üëâ"
    ];
    const hintSteps = [
      "PS : le bouton ‚ÄúNon‚Äù est un peu timide üòá",
      "Indice : il aime bien se sauver au dernier moment üòè",
      "Tu peux essayer‚Ä¶ mais il est tr√®s sportif üèÉ‚Äç‚ôÄÔ∏èüí®",
      "Je crois qu‚Äôil a peur de ton doigt üòÇ",
      "Plus tu insistes‚Ä¶ plus il panique üò≠",
      "Il faut cliquer sur oui ma L√©no... ‚ù§Ô∏è"
    ];

    let noInteractions = 0;
    let lastRandomIdx = -1;
    let roamingEnabled = false;
    let lastMoveAt = 0;

    const COOLDOWN_MS = 260;
    const NEAR_RADIUS = 95;
    const FAR_RADIUS = 140;  // hysteresis: must exit this radius to re-arm
    const PADDING = 12;

    let armed = true; // hysteresis arming

    const clamp = (v,min,max) => Math.max(min, Math.min(max, v));

    function setNoText(){
      if(noInteractions <= 5){ noBtn.textContent = noFirst[noInteractions - 1]; return; }
      let idx;
      do{ idx = (Math.random() * noRandomPool.length) | 0; }
      while(noRandomPool.length > 1 && idx === lastRandomIdx);
      lastRandomIdx = idx;
      noBtn.textContent = noRandomPool[idx];
    }

    function updateHint(){
      if(noInteractions < 1) return;
      hintEl.classList.add('show');
      const step = clamp(Math.floor((noInteractions - 1) / 2), 0, hintSteps.length - 1);
      hintEl.textContent = hintSteps[step];
    }

    function enableRoaming(){
      if(roamingEnabled) return;
      roamingEnabled = true;
      noBtn.classList.add('fixedRoam');
      const r = noBtn.getBoundingClientRect();
      placeNo(r.left, r.top);
    }

    function getAllowedZones(btnW, btnH){
      const c = card.getBoundingClientRect();

      // Allowed zones are rectangles around the card (top, bottom, left, right) INSIDE viewport.
      const zones = [];

      // TOP zone
      zones.push({
        x: PADDING,
        y: PADDING,
        w: innerWidth - 2*PADDING,
        h: Math.max(0, c.top - PADDING*2)
      });

      // BOTTOM zone
      zones.push({
        x: PADDING,
        y: c.bottom + PADDING,
        w: innerWidth - 2*PADDING,
        h: Math.max(0, innerHeight - (c.bottom + 2*PADDING))
      });

      // LEFT zone
      zones.push({
        x: PADDING,
        y: c.top + PADDING,
        w: Math.max(0, c.left - 2*PADDING),
        h: Math.max(0, (c.bottom - c.top) - 2*PADDING)
      });

      // RIGHT zone
      zones.push({
        x: c.right + PADDING,
        y: c.top + PADDING,
        w: Math.max(0, innerWidth - (c.right + 2*PADDING)),
        h: Math.max(0, (c.bottom - c.top) - 2*PADDING)
      });

      // filter zones where button fits
      return zones
        .filter(z => z.w >= btnW + PADDING && z.h >= btnH + PADDING)
        .map(z => ({
          xMin: z.x,
          xMax: z.x + z.w - btnW,
          yMin: z.y,
          yMax: z.y + z.h - btnH
        }));
    }

    function randomPointInZones(zones){
      // choose zone by area
      const areas = zones.map(z => (z.xMax - z.xMin) * (z.yMax - z.yMin));
      const total = areas.reduce((a,b)=>a+b,0);
      let r = Math.random() * total;
      let idx = 0;
      while(r > areas[idx]){ r -= areas[idx]; idx++; }
      const z = zones[idx];
      return {
        left: z.xMin + Math.random() * (z.xMax - z.xMin),
        top:  z.yMin + Math.random() * (z.yMax - z.yMin)
      };
    }

    function placeNo(left, top){
      // hard clamp into viewport (top-left coords)
      const r = noBtn.getBoundingClientRect();
      const bw = r.width, bh = r.height;
      const maxLeft = Math.max(PADDING, innerWidth - bw - PADDING);
      const maxTop  = Math.max(PADDING, innerHeight - bh - PADDING);

      const L = clamp(left, PADDING, maxLeft);
      const T = clamp(top,  PADDING, maxTop);

      noBtn.style.left = `${L}px`;
      noBtn.style.top  = `${T}px`;
    }

    function moveNo(){
      const now = Date.now();
      if(now - lastMoveAt < COOLDOWN_MS) return;
      lastMoveAt = now;

      noInteractions++;
      setNoText();
      updateHint();
      enableRoaming();

      // after text change, recompute actual size
      requestAnimationFrame(() => {
        const r = noBtn.getBoundingClientRect();
        const bw = r.width, bh = r.height;

        const zones = getAllowedZones(bw, bh);

        // fallback: if no zone available, just clamp to top-left (still inside screen)
        let pos;
        if(zones.length === 0){
          pos = { left: PADDING, top: PADDING };
        } else {
          pos = randomPointInZones(zones);
        }

        // avoid YES vicinity (if possible)
        const yesR = yesBtn.getBoundingClientRect();
        const yesCx = (yesR.left + yesR.right)/2;
        const yesCy = (yesR.top + yesR.bottom)/2;

        let tries = 0;
        while(tries < 25){
          const cx = pos.left + bw/2;
          const cy = pos.top + bh/2;
          if(Math.hypot(cx - yesCx, cy - yesCy) >= 220) break;
          pos = (zones.length ? randomPointInZones(zones) : { left: PADDING, top: PADDING });
          tries++;
        }

        placeNo(pos.left, pos.top);
      });
    }

    function distToNo(x,y){
      const r = noBtn.getBoundingClientRect();
      const cx = (r.left + r.right)/2;
      const cy = (r.top + r.bottom)/2;
      return Math.hypot(x - cx, y - cy);
    }

    addEventListener('mousemove', (e) => {
      if(!document.getElementById('screenAsk').classList.contains('active')) return;
      const d = distToNo(e.clientX, e.clientY);

      if(d > FAR_RADIUS) armed = true;
      if(armed && d < NEAR_RADIUS){
        armed = false;
        moveNo();
      }
    }, {passive:true});

    addEventListener('touchstart', (e) => {
      if(!document.getElementById('screenAsk').classList.contains('active')) return;
      const t = e.touches[0];
      if(!t) return;
      const d = distToNo(t.clientX, t.clientY);
      if(d < NEAR_RADIUS) moveNo();
    }, {passive:true});

    noBtn.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      if(document.getElementById('screenAsk').classList.contains('active')) moveNo();
    });

    addEventListener('resize', () => {
      if(roamingEnabled){
        const r = noBtn.getBoundingClientRect();
        placeNo(r.left, r.top);
      }
    });

    // ===== pop hearts =====
    const fx = document.getElementById('fx');
    const popChars = ["üíò","üíû","üíñ","üíï","‚ù§","üíó"];
    function spawnPopHeart(x, y){
      const el = document.createElement('div');
      el.className = 'popHeart';
      el.textContent = popChars[(Math.random()*popChars.length)|0];
      const dx = (Math.random()*2 - 1) * 140;
      const dy = -80 - Math.random()*180;
      const s  = 0.9 + Math.random()*0.9;
      const rr = (-18 + Math.random()*36) + "deg";
      el.style.left = x + "px";
      el.style.top  = y + "px";
      el.style.setProperty('--dx', dx + "px");
      el.style.setProperty('--dy', dy + "px");
      el.style.setProperty('--s', s.toFixed(2));
      el.style.setProperty('--r', rr);
      el.style.fontSize = (16 + Math.random()*16) + "px";
      fx.appendChild(el);
      setTimeout(() => el.remove(), 950);
    }
    function popHeartsFromElement(el){
      const r = el.getBoundingClientRect();
      const x = (r.left + r.right)/2;
      const y = (r.top + r.bottom)/2;
      for(let i=0;i<14;i++) setTimeout(() => spawnPopHeart(x, y), i*12);
      for(let i=0;i<8;i++) setTimeout(() => spawnPopHeart(x + (Math.random()*40-20), y + (Math.random()*20-10)), 220 + i*40);
    }

    // ===== loading =====
    const barFill = document.getElementById('barFill');
    const pct = document.getElementById('pct');
    const loadingText = document.getElementById('loadingText');
    const loadPhoto = document.getElementById('loadPhoto');

    const loadingPhrases = [
      "Chargement de l‚Äôamour en cours‚Ä¶ üíò",
      "Pr√©paration des sentiments‚Ä¶ üíû",
      "Assemblage des bisous‚Ä¶ üòò",
      "Polissage de la bague‚Ä¶ üíç",
      "Ajout de c√¢lins illimit√©s‚Ä¶ ü´∂",
      "Mon amour‚Ä¶ ‚ù§Ô∏è",
      "R√©servation de la table au N≈™‚Ä¶ üçΩÔ∏è‚ú®"
    ];

    function easeInOutCubic(t){
      return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3)/2;
    }
    function setLoadingPhraseSmooth(txt){
      loadingText.classList.add('fadeOut');
      setTimeout(() => {
        loadingText.textContent = txt;
        loadingText.classList.remove('fadeOut');
      }, 240);
    }

    const loadPhotos = [
      "assets/final1.png",
      "assets/final3.png",
      "assets/final4.png",
      "assets/final5.png",
      "assets/final6.png",
      "assets/final7.png",
      "assets/final8.png"
    ];
    function startSlideshow(totalMs){
      let i = 0;
      loadPhoto.src = loadPhotos[0];
      const stepMs = Math.max(750, Math.floor(totalMs / Math.max(loadPhotos.length, 5)));
      const timer = setInterval(() => {
        i = (i + 1) % loadPhotos.length;
        loadPhoto.classList.add('fade');
        setTimeout(() => {
          loadPhoto.src = loadPhotos[i];
          loadPhoto.classList.remove('fade');
        }, 220);
      }, stepMs);
      return timer;
    }

    function runLoading(){
      if(roamingEnabled){
        noBtn.style.opacity = '0';
        noBtn.style.pointerEvents = 'none';
      }
      card.classList.add('loadingMode');
      showScreen('screenLoad');

      const totalMs = 5800;
      const slideTimer = startSlideshow(totalMs);

      const lastHold = 1200;
      const tLast = totalMs - lastHold;
      const schedule = [
        { t:   0, txt: loadingPhrases[0] },
        { t: 900, txt: loadingPhrases[1] },
        { t:1800, txt: loadingPhrases[2] },
        { t:2700, txt: loadingPhrases[3] },
        { t:3600, txt: loadingPhrases[4] },
        { t:4500, txt: loadingPhrases[5] },
        { t:tLast, txt: loadingPhrases[6] }
      ];
      for(const s of schedule) setTimeout(() => setLoadingPhraseSmooth(s.txt), s.t);

      const start = performance.now();
      const tick = (now) => {
        const raw = Math.max(0, Math.min(1, (now - start) / totalMs));
        const eased = easeInOutCubic(raw);
        const p = Math.round(eased * 100);
        pct.textContent = p;
        barFill.style.width = `${p}%`;

        if(raw < 1) requestAnimationFrame(tick);
        else{
          clearInterval(slideTimer);
          setTimeout(() => {
            card.classList.remove('loadingMode');
            showScreen('screenDone');
            startFinalCarousel();
          }, 420);
        }
      };
      requestAnimationFrame(tick);
    }

    // ===== FINAL carousel =====
    const slotEls = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3')
    ];
    const finalCyclePhotos = [
      "assets/final9.png",
      "assets/final2.png",
      "assets/final8.png",
      "assets/final7.png",
      "assets/final6.png",
      "assets/final5.png",
      "assets/final4.png",
      "assets/final3.png",
      "assets/final1.png"
    ];

    let finalStarted = false;
    let finalIdx = 0;
    let slotIdx = 0;
    let z = 10;

    function showInSlot(slotEl, src){
      slotEl.classList.remove('show');
      setTimeout(() => {
        slotEl.src = src;
        slotEl.style.zIndex = String(++z);
        slotEl.classList.add('show');
      }, 90);
    }

    function startFinalCarousel(){
      if(finalStarted) return;
      finalStarted = true;

      slotEls.forEach(s => { s.classList.remove('show'); s.src=""; s.style.zIndex="0"; });
      finalIdx = 0; slotIdx = 0; z = 10;

      const step = () => {
        const slot = slotEls[slotIdx % 3];
        const src = finalCyclePhotos[finalIdx % finalCyclePhotos.length];
        showInSlot(slot, src);
        finalIdx++; slotIdx++;
        setTimeout(step, 3000);
      };
      step();
    }

    // YES click
    yesBtn.addEventListener('click', () => {
      popHeartsFromElement(yesBtn);
      setTimeout(runLoading, 420);
    });
  </script>
</body>
</html>
